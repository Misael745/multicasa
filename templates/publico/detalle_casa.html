{% extends 'base.html' %}

{% block title %}{{ casa.titulo }} - Multicasa{% endblock %}

{% block content %}
    <div class="row">
        <div class="col-lg-8">

            {% if casa.imagenes.all %}
                <div id="carouselCasa" class="carousel slide mb-4" data-bs-ride="carousel">
                    <div class="carousel-inner rounded shadow-sm">
                        {% for img in casa.imagenes.all %}
                            <div class="carousel-item {% if forloop.first %}active{% endif %}">
                                <img src="{{ img.get_image_src }}" class="d-block w-100"
                                    style="height: 500px; object-fit: cover;" 
                                    alt="{{ img.texto_alternativo|default:'Imagen de propiedad' }}">
                            </div>
                        {% endfor %}
                    </div>

                    <button class="carousel-control-prev" type="button" data-bs-target="#carouselCasa"
                            data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Anterior</span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#carouselCasa"
                            data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Siguiente</span>
                    </button>
                </div>
            {% else %}
                <div class="alert alert-secondary">Esta casa no tiene imágenes disponibles.</div>
            {% endif %}

            <div class="card mb-4">
                <div class="card-header">Ubicación</div>
                <div class="card-body">
                    <p><strong>Dirección:</strong> {{ casa.direccion }}</p>
                    <div id="map" style="height: 400px; width: 100%; border-radius: 8px; z-index: 1;"></div>

                    <script>
                        document.addEventListener('DOMContentLoaded', function () {
                            // 1. Obtenemos las coordenadas de la casa (o usamos unas por defecto si no tiene)
                            // Nota: 'safe' es necesario para que Django no escape los números decimales
                            var latitud = "{{ casa.latitud|default:'19.4326' }}";
                            var longitud = "{{ casa.longitud|default:'-99.1332' }}";
                            var titulo = "{{ casa.titulo|escapejs }}";

                            // Convertimos a números flotantes
                            var lat = parseFloat(latitud);
                            var lng = parseFloat(longitud);

                            // Verificamos si las coordenadas son válidas (distintas de 0 o nulas)
                            if (lat && lng) {
                                // 2. Inicializamos el mapa en el div con id="map"
                                var map = L.map('map').setView([lat, lng], 15);

                                // 3. Cargamos las capas de OpenStreetMap (El diseño del mapa)
                                L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                                    maxZoom: 19,
                                    attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                                }).addTo(map);

                                // 4. Agregamos el marcador (pin) en la ubicación
                                var marker = L.marker([lat, lng]).addTo(map);

                                // 5. Le ponemos un pop-up con el nombre de la casa
                                marker.bindPopup("<b>" + titulo + "</b><br>Ubicación exacta.").openPopup();
                            } else {
                                document.getElementById('map').innerHTML = '<div class="alert alert-warning">Ubicación no disponible para esta propiedad.</div>';
                            }
                        });
                    </script>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <h1 class="card-title h3 mb-3">{{ casa.titulo }}</h1>
                    <h2 class="text-primary fw-bold mb-4">${{ casa.precio }}</h2>

                    <ul class="list-group list-group-flush mb-4">
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Habitaciones:</span>
                            <strong>{{ casa.habitaciones|default:"N/A" }}</strong>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Baños:</span>
                            <strong>{{ casa.banos|default:"N/A" }}</strong>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Superficie:</span>
                            <strong>{{ casa.superficie_m2|default:"N/A" }} m²</strong>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Estatus:</span>
                            <span class="badge {% if casa.estatus == 'en venta' %}bg-success{% else %}bg-danger{% endif %}">
                            {{ casa.estatus|title }}
                        </span>
                        </li>
                    </ul>

                    <h5>Descripción</h5>
                    <p class="card-text text-muted">{{ casa.descripcion|linebreaks }}</p>

                    <div class="d-grid gap-2 mt-4">
                        <a href="{% url 'generar_pdf_casa' casa.id_casa %}" class="btn btn-outline-danger">
                            Descargar Ficha Técnica (PDF)
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>

{% endblock %}